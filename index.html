<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WebAR — targets por ORDEM → vídeos N.mp4 (sem JSON)</title>

  <!-- A-Frame + MindAR -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js" defer></script>

  <style>
    html, body { margin: 0; padding: 0; background: #000; overflow: hidden; }
    body, a-scene { width: 100vw; height: 100vh; }

    #hud {
      position: fixed; top: 12px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.7); color: #0f0; font: 12px/1.35 monospace;
      padding: 8px 12px; border-radius: 8px; z-index: 99999; min-width: 280px;
    }
    #hud b { color: #fff; }
    #hud .warn { color: #ff6; }
  </style>
</head>
<body>

<div id="hud">
  <div><b>WebAR: ordem de targets → vídeos N.mp4</b></div>
  <div id="status">Carregando...</div>
</div>

<a-scene
  mindar-image="imageTargetSrc: ./targets.mind; maxTrack: 1"
  renderer="alpha:true; antialias:false; physicallyCorrectLights:false"
  embedded
  vr-mode-ui="enabled:false"
  device-orientation-permission-ui="enabled:false"
  style="width:100vw; height:100vh;">

  <a-assets id="assets" timeout="15000"></a-assets>

  <a-camera look-controls="enabled:false"></a-camera>
  <a-entity id="anchors"></a-entity>
</a-scene>

<script>
  // ===== CONFIG =====
  // Ajuste para a quantidade de alvos que existem no seu targets.mind:
  const NUM_TARGETS = 2; // target 01..NUM_TARGETS → vídeos "1.mp4" .. "NUM_TARGETS.mp4"
  const DEBUG = false;   // true para mostrar índice/arquivo no HUD

  // ===== IMPLEMENTAÇÃO =====
  const sceneEl = document.querySelector('a-scene');
  const anchorsRoot = document.getElementById('anchors');
  const assets = document.getElementById('assets');
  const statusEl = document.getElementById('status');

  // Cache-bust forte por load
  const CACHE_BUST = 'cb=' + Date.now();

  function makeVideoAsset(id, src) {
    const v = document.createElement('video');
    v.id = id;
    v.setAttribute('preload', 'metadata');
    v.setAttribute('playsinline', '');
    v.setAttribute('webkit-playsinline', '');
    v.setAttribute('muted', '');   // autoplay em mobile
    v.setAttribute('loop', '');
    v.setAttribute('crossorigin', 'anonymous');
    v.src = src;
    assets.appendChild(v);
    return v;
  }

  function makePlane(videoId) {
    const p = document.createElement('a-video');
    p.setAttribute('src', '#' + videoId);
    p.setAttribute('position', '0 0 0.01');
    p.setAttribute('width', '1'); // <a-video> ajusta altura conforme proporção
    return p;
  }

  async function setup() {
    anchorsRoot.innerHTML = '';
    assets.innerHTML = '';

    const videos = [];
    for (let i = 0; i < NUM_TARGETS; i++) {
      const human = i + 1;
      const file = human + '.mp4';           // "1.mp4", "2.mp4", ...
      const url  = './' + file + '?' + CACHE_BUST;

      const vidId = 'vid_' + i;
      const vidEl = makeVideoAsset(vidId, url);
      videos.push(vidEl);

      const anchor = document.createElement('a-entity');
      anchor.setAttribute('mindar-image-target', 'targetIndex: ' + i);

      const plane = makePlane(vidId);
      anchor.appendChild(plane);
      anchorsRoot.appendChild(anchor);

      anchor.addEventListener('targetFound', async () => {
        // pausa os outros
        videos.forEach((v, j) => { if (j !== i) { try { v.pause(); } catch(_){} } });
        try {
          await vidEl.play();
          statusEl.innerHTML = 'targetFound index=<b>' + i + '</b> → ' + file;
        } catch(e) {
          statusEl.innerHTML = 'targetFound index=<b>' + i + '</b> → ' + file + ' <span class="warn">(toque na tela para iniciar)</span>';
        }
        if (DEBUG) console.log('targetFound', {index:i, file});
      });

      anchor.addEventListener('targetLost', () => {
        try { vidEl.pause(); } catch(_) {}
        if (DEBUG) console.log('targetLost', {index:i});
      });
    }
  }

  (async () => {
    await new Promise(res => sceneEl.hasLoaded ? res() : sceneEl.addEventListener('loaded', res, { once: true }));
    await new Promise(res => {
      const done = () => res();
      sceneEl.addEventListener('arReady', done, { once: true });
      setTimeout(done, 2000);
    });
    statusEl.textContent = 'Pronto. Mire nas imagens 01, 02, ... → toca 1.mp4, 2.mp4, ...';
    setup();
  })();
</script>
</body>
</html>
