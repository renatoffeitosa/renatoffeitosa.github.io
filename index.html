<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WebAR — iOS Safari robusto (JSON + cover) • targets 5,5×8 cm</title>

  <!-- A-Frame + MindAR -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js" defer></script>

  <style>
    :root {
      --sa-top: env(safe-area-inset-top, 0px);
      --sa-bottom: env(safe-area-inset-bottom, 0px);
    }
    html, body { margin: 0; padding: 0; background: transparent; overflow: hidden; }
    body, a-scene { width: 100vw; height: 100vh; }
    .a-canvas, canvas { background: transparent !important; display: block; }

    /* Hint (box amarelo 80% + fonte preta) */
    #hint {
      position: fixed; left: 50%; top: calc(16px + var(--sa-top)); transform: translateX(-50%);
      background: rgba(255, 214, 0, 0.8); /* amarelo com 80% */
      color: #000; /* fonte preta */
      border-radius: 12px; padding: 8px 14px; text-align: center;
      font: 500 12px/1.2 system-ui, -apple-system, Roboto, Arial, sans-serif;
      pointer-events: none; user-select: none; z-index: 9999;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    }

    /* Logo: 20% menor, alinhado à esquerda, 20px das bordas */
    #logo {
      position: fixed; left: 20px; bottom: calc(20px + var(--sa-bottom));
      pointer-events: none; z-index: 9999;
    }
    #logo img {
      display: block; height: auto;
      /* Redução de ~20%: se antes estava em 40vw/220px, reduza 20% */
      max-width: 176px; /* 220px * 0.8 */
      width: 32vw;      /* 40vw * 0.8 */
    }

    /* Botão Reiniciar AR: ícone REFRESH.svg sem texto, lado direito, 20px da borda direita e inferior */
    #restartBtn {
      position: fixed; right: 20px; bottom: calc(20px + var(--sa-bottom));
      z-index: 9999; display: none; cursor: pointer; border: 0; background: transparent; padding: 0;
      width: 52px; height: 52px;
      filter: drop-shadow(0 4px 16px rgba(0,0,0,.25));
    }
    #restartBtn img { display: block; width: 100%; height: 100%; }

    /* Overlay iOS: botão Iniciar com box amarelo e fonte preta */
    #iosOverlay {
      position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.6); z-index: 10000;
    }
    #iosOverlay .card {
      background: #101418; color: #fff; padding: 16px 18px; border-radius: 14px;
      font: 500 14px/1.4 system-ui, -apple-system, Roboto, Arial, sans-serif;
      text-align: center; width: min(86vw, 520px); box-shadow: 0 6px 24px rgba(0,0,0,.35);
    }
    #btnStart {
      margin-top: 10px; padding: 10px 14px; border-radius: 10px; border: 0; cursor: pointer;
      font: 600 14px/1 system-ui, -apple-system, Roboto, Arial, sans-serif;
      background: rgba(255, 214, 0, 0.8); color: #000; /* amarelo 80% + preto */
    }
  </style>
</head>
<body>

  <div id="hint">aponte a câmera para a carta</div>

  <div id="logo">
    <img src="./LOGO_DUOMEMO.png" alt="LOGO_DUOMEMO" />
  </div>

  <!-- Botão Restart como ícone -->
  <button id="restartBtn" type="button" aria-label="Reiniciar AR">
    <img src="./REFRESH.svg" alt="Reiniciar" />
  </button>

  <!-- Overlay para iOS: desbloquear autoplay de vídeo com um toque -->
  <div id="iosOverlay">
    <div class="card">
      <div>Para iniciar a AR no iPhone, toque em <b>Iniciar</b> para liberar a câmera e o vídeo.</div>
      <button id="btnStart" type="button">Iniciar</button>
    </div>
  </div>

  <a-scene id="scene"
    renderer="alpha:true; antialias:false; physicallyCorrectLights:false"
    embedded
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:true"
    style="width:100vw; height:100vh;">

    <a-assets id="assets" timeout="15000"></a-assets>

    <a-camera look-controls="enabled:false"></a-camera>
    <a-entity id="anchors"></a-entity>
  </a-scene>

  <script>
    // ===== Proporções dos targets (5,5 x 8 cm) =====
    const DEFAULT_TARGET_ASPECT = 5.5 / 8; // 0.6875 (largura/altura)
    const TARGET_ASPECTS = []; // Use por índice se algum target tiver proporção diferente

    // ===== Cache-bust =====
    const PAGE_BUST = 'pv=' + Date.now();

    // ===== Seletores =====
    const sceneEl = document.getElementById('scene');
    const anchorsRoot = document.getElementById('anchors');
    const assets = document.getElementById('assets');
    const iosOverlay = document.getElementById('iosOverlay');
    const restartBtn = document.getElementById('restartBtn');
    const btnStart = document.getElementById('btnStart');
    const hintEl = document.getElementById('hint');

    // Aplica cache-bust ao .mind
    sceneEl.setAttribute('mindar-image', `imageTargetSrc: ./targets.mind?${PAGE_BUST}; maxTrack: 1`);

    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    function getTargetAspect(i){
      const a = TARGET_ASPECTS[i];
      return (typeof a === 'number' && a > 0) ? a : DEFAULT_TARGET_ASPECT;
    }

    function makeVideoAsset(id, src){
      const v = document.createElement('video');
      v.id = id;
      v.setAttribute('preload','metadata');
      v.setAttribute('playsinline','');
      v.setAttribute('webkit-playsinline','');
      v.setAttribute('muted','');
      v.setAttribute('loop','');
      v.setAttribute('crossorigin','anonymous');
      v.src = src;
      assets.appendChild(v);
      return v;
    }
    function makePlane(){ const p = document.createElement('a-video'); p.setAttribute('position','0 0 0.01'); return p; }

    // Cover para o retângulo do target mantendo proporção do vídeo
    function fitVideoCoverToTarget(planeEl, videoEl, targetAspect){
      const widthTarget = 1.0, heightTarget = widthTarget / targetAspect;
      const vw = videoEl.videoWidth||0, vh = videoEl.videoHeight||0;
      if(!vw || !vh){ videoEl.addEventListener('loadedmetadata',()=>fitVideoCoverToTarget(planeEl, videoEl, targetAspect),{once:true}); return; }
      const aspectVideo = vw / vh;
      let width = widthTarget, height = width / aspectVideo;
      if(height < heightTarget){ width = heightTarget * aspectVideo; height = width / aspectVideo; }
      planeEl.setAttribute('width', width.toFixed(5));
      planeEl.setAttribute('height', height.toFixed(5));
    }

    async function loadTargetsList(){
      const res = await fetch('./targets.json', { cache: 'no-store' });
      if(!res.ok) throw new Error('targets.json não encontrado');
      const arr = await res.json();
      if(!Array.isArray(arr) || !arr.every(s => typeof s === 'string')) throw new Error('targets.json inválido. Esperado: ["1.mp4","2.mp4", ...]');
      return arr;
    }

    // Desbloqueia autoplay no iOS tocando/pausando rapidamente cada vídeo
    async function unlockIOSAutoplay(videos){
      for(const v of videos){
        try { await v.play(); v.pause(); v.currentTime = 0; } catch(_) {}
      }
    }

    let hintHid = false;
    function hideHintOnce(){
      if(!hintHid && hintEl){
        hintHid = true;
        hintEl.style.transition = 'opacity .25s ease';
        hintEl.style.opacity = '0';
        setTimeout(()=> hintEl.style.display='none', 250);
      }
    }

    async function setup(){
      anchorsRoot.innerHTML = ''; assets.innerHTML = '';
      const list = await loadTargetsList(); const videos = [];
      const bust = 'cb=' + Date.now();

      list.forEach((file, i)=>{
        const vidId = 'vid_'+i, url = './'+file+'?'+bust;
        const vidEl = makeVideoAsset(vidId, url); videos.push(vidEl);

        const anchor = document.createElement('a-entity'); anchor.setAttribute('mindar-image-target','targetIndex: '+i);
        const plane = makePlane(); plane.setAttribute('src', '#'+vidId);
        plane.setAttribute('material', 'transparent:true; opacity:0'); // para fade-in suave
        anchor.appendChild(plane); anchorsRoot.appendChild(anchor);

        const tAspect = getTargetAspect(i);
        if(vidEl.readyState>=1) fitVideoCoverToTarget(plane, vidEl, tAspect);
        else vidEl.addEventListener('loadedmetadata',()=>fitVideoCoverToTarget(plane, vidEl, tAspect),{once:true});

        anchor.addEventListener('targetFound', async ()=>{
          // fade-in
          plane.setAttribute('animation__fadein','property=material.opacity;from=0;to=1;dur=220;easing=easeOutSine');
          // pausa os demais
          videos.forEach((v,j)=>{ if(j!==i){ try{ v.pause(); }catch(_){}} });
          try{ await vidEl.play(); }catch(e){}
          hideHintOnce();
        });
        anchor.addEventListener('targetLost', ()=>{
          plane.setAttribute('animation__fadeout','property=material.opacity;from=1;to=0;dur=200;easing=easeInSine');
          setTimeout(()=>{ try{ vidEl.pause(); }catch(_){}} , 200);
        });
      });

      // iOS: overlay de início + mostrar botão de reinício
      if (isIOS) {
        iosOverlay.style.display = 'flex';
        restartBtn.style.display = 'block';
        btnStart.onclick = async () => { await unlockIOSAutoplay(videos); iosOverlay.style.display = 'none'; };
      } else {
        restartBtn.style.display = 'block';
      }

      // Reinício manual (ícone REFRESH)
      restartBtn.onclick = () => safeRestartAR('manual');
    }

    // Robustez de sessão
    let restartedOnce = false;
    function safeRestartAR(){
      if(restartedOnce) return;
      restartedOnce = true;
      try{
        const sys = sceneEl.systems['mindar-image-system'];
        if(sys){ sys.stop?.(); setTimeout(()=> { sys.start?.(); restartedOnce=false; }, 400); }
        else { location.replace(location.pathname + '?r=' + Date.now()); }
      }catch(_){ location.replace(location.pathname + '?r=' + Date.now()); }
    }

    window.addEventListener('pageshow', (e)=>{ if(e.persisted){ location.replace(location.pathname + '?r=' + Date.now()); } });
    window.addEventListener('webglcontextlost', (e)=>{ e.preventDefault(); location.replace(location.pathname + '?r=' + Date.now()); }, false);
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden){ safeRestartAR(); } });
    sceneEl.addEventListener('arError', ()=> safeRestartAR());
    window.addEventListener('pagehide', ()=>{
      try{ sceneEl.systems['mindar-image-system']?.stop?.(); }catch(_){}
      document.querySelectorAll('video').forEach(v=>{ try{ v.pause(); v.removeAttribute('src'); v.load(); }catch(_){} });
    });

    (async ()=>{
      await new Promise(res => sceneEl.hasLoaded ? res() : sceneEl.addEventListener('loaded', res, { once:true }));
      await new Promise(res => { const done=()=>res(); sceneEl.addEventListener('arReady', done, { once:true }); setTimeout(done, 2000); });
      setup().catch(err=>{ console.error(err); alert(err.message); });
    })();
  </script>
</body>
</html>
