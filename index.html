<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WebAR — targets por ORDEM → vídeos NN.mp4 (sem JSON)</title>

  <!-- A-Frame + MindAR -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js" defer></script>

  <style>
    html, body { margin: 0; padding: 0; background: #000; overflow: hidden; }
    body, a-scene { width: 100vw; height: 100vh; }

    #hud {
      position: fixed; top: 12px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.7); color: #0f0; font: 12px/1.35 monospace;
      padding: 8px 12px; border-radius: 8px; z-index: 99999; min-width: 280px;
    }
    #hud b { color: #fff; }
    #hud .warn { color: #ff6; }
    #hud .err { color: #f66; }
  </style>
</head>
<body>

<div id="hud">
  <div><b>WebAR: ordem de targets → vídeos NN.mp4</b></div>
  <div id="status">Aguardando AR...</div>
</div>

<a-scene
  mindar-image="imageTargetSrc: ./targets.mind; maxTrack: 1"
  renderer="alpha:true; antialias:false; physicallyCorrectLights:false"
  embedded
  vr-mode-ui="enabled:false"
  device-orientation-permission-ui="enabled:false"
  style="width:100vw; height:100vh;">

  <a-assets id="assets" timeout="15000"></a-assets>

  <a-camera look-controls="enabled:false"></a-camera>
  <a-entity id="anchors"></a-entity>
</a-scene>

<script>
  // ===== CONFIG =====
  // Ajuste o número de targets existentes no seu targets.mind (ordem = targetIndex)
  // index 0 → 01.mp4; index 1 → 02.mp4; index 2 → 03.mp4; ...
  const NUM_TARGETS = 2; // <- edite aqui conforme sua quantidade real
  const ZERO_PAD = 2;    // tamanho do padding nos nomes dos vídeos (01, 02, 03...)

  // Mostrar info de debug (índice/arquivo) no HUD
  const DEBUG = false;

  // ===== IMPLEMENTAÇÃO =====
  const sceneEl = document.querySelector('a-scene');
  const anchorsRoot = document.getElementById('anchors');
  const assets = document.getElementById('assets');
  const statusEl = document.getElementById('status');

  // Sufixo único por load para matar cache (cache-bust forte)
  const CACHE_BUST = 'cb=' + Date.now();

  // Zero-pad helper
  const pad = (num, size) => String(num).padStart(size, '0');

  // Cria um <video> asset isolado
  function createVideoAsset(id, src) {
    const v = document.createElement('video');
    v.id = id;
    v.setAttribute('preload', 'metadata');
    v.setAttribute('playsinline', '');
    v.setAttribute('webkit-playsinline', '');
    v.setAttribute('muted', '');
    v.setAttribute('loop', '');
    v.setAttribute('crossorigin', 'anonymous');
    v.src = src;
    assets.appendChild(v);
    return v;
  }

  // <a-video> mantém aspect ratio automaticamente
  function createVideoPlane(videoId) {
    const plane = document.createElement('a-video');
    plane.setAttribute('src', '#' + videoId);
    plane.setAttribute('position', '0 0 0.01');
    plane.setAttribute('width', '1'); // altura ajustada pelo próprio a-video
    return plane;
  }

  // HEAD para checar presença de arquivo e também induzir "miss" no cache do CDN
  async function headOk(url) {
    try {
      const res = await fetch(url, { method: 'HEAD', cache: 'no-store' });
      // aceitar seja qual for o content-type, pois alguns CDNs não retornam "video/*" no HEAD
      return res.ok;
    } catch (e) {
      return false;
    }
  }

  async function setup() {
    anchorsRoot.innerHTML = '';
    assets.innerHTML = '';

    const videos = [];
    for (let i = 0; i < NUM_TARGETS; i++) {
      const indexHuman = i + 1;
      const filename = pad(indexHuman, ZERO_PAD) + '.mp4';
      const url = './' + filename + (filename.includes('?') ? '&' : '?') + CACHE_BUST;

      // checagem (opcional) — não bloqueia, só informa
      headOk(url).then(ok => {
        if (!ok && DEBUG) {
          console.warn('Arquivo não encontrado (HEAD falhou):', filename);
        }
      });

      const videoId = 'vid_' + i;
      const videoEl = createVideoAsset(videoId, url);
      videos.push(videoEl);

      const anchor = document.createElement('a-entity');
      anchor.setAttribute('mindar-image-target', 'targetIndex: ' + i);

      const plane = createVideoPlane(videoId);
      anchor.appendChild(plane);
      anchorsRoot.appendChild(anchor);

      anchor.addEventListener('targetFound', async () => {
        // pausa demais
        videos.forEach((v, j) => { if (j !== i) { try { v.pause(); } catch(_){} } });
        // toca o correspondente
        try {
          await videoEl.play();
          statusEl.innerHTML = 'targetFound index=<b>' + i + '</b> → ' + filename;
        } catch (e) {
          statusEl.innerHTML = 'targetFound index=<b>' + i + '</b> → ' + filename + ' <span class="warn">(toque na tela para iniciar)</span>';
        }
        if (DEBUG) console.log('targetFound', {index:i, file:filename});
      });

      anchor.addEventListener('targetLost', () => {
        try { videoEl.pause(); } catch(_) {}
        if (DEBUG) console.log('targetLost', {index:i});
      });
    }
  }

  (async () => {
    statusEl.textContent = 'Carregando cena...';
    await new Promise(res => sceneEl.hasLoaded ? res() : sceneEl.addEventListener('loaded', res, { once: true }));
    await new Promise(res => {
      const done = () => res();
      sceneEl.addEventListener('arReady', done, { once: true });
      setTimeout(done, 2000);
    });
    statusEl.textContent = 'Pronto. Mire nas imagens 01, 02, ... → vídeos 01.mp4, 02.mp4, ...';
    setup();
  })();
</script>
</body>
</html>
